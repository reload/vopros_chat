<?php

/**
 * @file
 * Vopros chat module.
 */

/**
 * Implements hook_menu().
 */
function vopros_chat_menu() {
  $items = array();

  $items['embed/ask-question/chat/%/%'] = array(
    'title' => 'Chat',
    'page callback' => 'vopros_chat_client_page',
    'page arguments' => array(3, 4),
    // @todo access callback should check that chat id is bound to a question.
    'access callback' => TRUE,
    'file' => 'vopros_chat.pages.inc',
    'delivery callback' => 'vopros_embed_deliver_html_page',
  );

  return $items;
}

/**
 * Implements hook_vopros_question_user_answer_preference().
 *
 * Exposes chat as an user answer preference for questions.
 */
function vopros_chat_vopros_question_user_answer_preference() {
  return array('chat' => t('Chat'));
}

/**
 * Implements hook_views_default_views_alter().
 *
 * On unmodified Question List views we filter out chat questions.
 *
 * If you don't want this filtered set the variable
 * 'vopros_chat_filter_question_list' to FALSE. No need to override the view
 * just for this.
 *
 * Overridden views will be changed on hook_enable().
 *
 * @see vopros_chat_enable()
 */
function vopros_chat_views_default_views_alter(&$views) {
  $enabled = variable_get('vopros_chat_filter_question_list', TRUE);

  if ($enabled && isset($views['vopros_question_list'])) {
    $filter = array(
      'operator' => '!=',
      'value' => 'chat',
    );

    foreach ($views['vopros_question_list']->display as $display) {
      $views['vopros_question_list']->add_item($display->display_plugin, 'filter', 'vopros_question', 'user_answer_preference', $filter, 'vopros_chat_filter');
    }
  }
}
